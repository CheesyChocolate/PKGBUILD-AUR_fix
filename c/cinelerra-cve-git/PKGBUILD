# Maintainer: Fabio 'Lolix' Loli <fabio.loli@disroot.org> -> https://github.com/FabioLolix
# Contributer: Geballin - Guillaume Ballin <macniaque at free dot fr>
# Contributor: Ray Rashif <schiv@archlinux.org>
# Contributor: Daniel J Griffiths <ghost1227@archlinux.us>
# Contributor: Jaroslaw Swierczynski <swiergot@aur.archlinux.org>
# Contributor: Alexander RÃ¸dseth <rodseth@gmail.com>

pkgname=cinelerra-cve-git
pkgver=r6126.6c5d0c3b
pkgrel=1
pkgdesc="Professional video editing and compositing environment - vanakala version"
arch=(x86_64)
url="https://github.com/vanakala/cinelerra-cve"
license=(GPL)
depends=(e2fsprogs libavc1394 libiec61883 libxv
         libtiff mjpegtools fftw a52dec glu
         faad2 faac openexr libxft
         alsa-lib)
makedepends=(git automake nasm mesa intltool)
options=(!lto)
source=("git+https://github.com/vanakala/cinelerra-cve.git"
        https://ffmpeg.org/releases/ffmpeg-4.4.5.tar.xz)
sha512sums=('SKIP'
            '70df4e63ef507a7ec76da34438142499139769728fd5130d9cf48d56c110ec82c3d6a7e6d1622da03c70167fa861d901d016bbe52c21d2b284b8a0d9f30811dc')
noextract=(ffmpeg-4.4.5.tar.xz)

# check ffmpeg in ./configure, fails to build using system version, 

pkgver() {
  cd "cinelerra-cve"
  printf "r%s.%s" "$(git rev-list --count HEAD)" "$(git rev-parse --short HEAD)"
}

prepare() {
  cd "cinelerra-cve"
  bsdtar -xf ../ffmpeg-4.4.5.tar.xz
  mv ffmpeg-4.4.5 ffmpeg
  ./autogen.sh
}

build() {
  cd "cinelerra-cve"
  # disable mmx due to improper use of registers in asm
  # - possibly a new problem since gcc 4.9
  ./configure pkg_config='pkg-config --static' \
    --prefix=/usr \
    --with-buildinfo=git \
    --enable-opengl \
    --disable-esd
  make
}

package() {
  cd "cinelerra-cve"
  make DESTDIR="$pkgdir" install
  install -t "${pkgdir}/usr/share/doc/cinelerra-cve" \
    -vDm644 {AUTHORS,ChangeLog,README.BUILD}
  rm -rf "${pkgdir}/usr/share/ffmpeg/examples"
}
